<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - XGENAI</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="typography.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }

        .admin-header {
            margin-bottom: 3rem;
            text-align: center;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--light-bg);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: var(--text-secondary);
        }

        .section-title {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }

        .users-table, .emails-table {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 3rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            font-weight: 600;
            color: var(--primary-color);
        }

        td {
            color: var(--text-secondary);
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .email-content {
            max-width: 300px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .btn-clear {
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-clear:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="/"><h2>XGEN<span>AI</span></h2></a>
            </div>
            <ul class="nav-menu">
                <li><a href="/#home">Home</a></li>
                <li><a href="/auth">Login / Sign Up</a></li>
                <li><a href="/admin" style="color: var(--primary-color);">Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <p style="color: var(--text-secondary);">Manage registered users and view email confirmations</p>
            <div style="margin-top: 1rem;">
                <button onclick="checkDatabase()" style="padding: 0.5rem 1rem; background: var(--accent-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 0.5rem;">
                    Check Database Status
                </button>
                <span id="dbStatus" style="color: var(--text-secondary); font-size: 0.875rem;"></span>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card">
                <h3 id="totalEmails">0</h3>
                <p>Emails Sent</p>
            </div>
            <div class="stat-card">
                <h3 id="todayUsers">0</h3>
                <p>Users Today</p>
            </div>
        </div>

        <!-- Users Table -->
        <div class="users-table">
            <h2 class="section-title">Registered Users</h2>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Created At</th>
                        <th>Last Login</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="no-data">No users registered yet</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Emails Table -->
        <div class="emails-table">
            <h2 class="section-title">Confirmation Emails</h2>
            <table id="emailsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Sent At</th>
                        <th>User Name</th>
                        <th>Content Preview</th>
                    </tr>
                </thead>
                <tbody id="emailsTableBody">
                    <tr>
                        <td colspan="6" class="no-data">No emails sent yet</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Job Applications Section -->
        <div id="jobApplicationsSection" style="margin-top: 3rem;">
            <h2 class="section-title">Job Applications</h2>
            <p class="no-data">Loading applications...</p>
        </div>

        <!-- Intern Management Section -->
        <div style="margin-top: 3rem; background: var(--light-bg); padding: 2rem; border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
            <h2 class="section-title" style="color: #00d4ff;">
                <i class="fas fa-user-graduate"></i> Intern Management System
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                Select interns from applications and manage their weekly tasks and progress
            </p>

            <!-- Tabs for Intern Management -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid rgba(0, 212, 255, 0.2);">
                <button class="intern-tab active" onclick="showInternTab('selected')" id="selectedTab">
                    <i class="fas fa-users"></i> Selected Interns
                </button>
                <button class="intern-tab" onclick="showInternTab('tasks')" id="tasksTab">
                    <i class="fas fa-tasks"></i> Weekly Tasks
                </button>
                <button class="intern-tab" onclick="showInternTab('submissions')" id="submissionsTab">
                    <i class="fas fa-upload"></i> Submissions
                </button>
            </div>

            <!-- Selected Interns Tab -->
            <div id="selectedInternsTab" class="intern-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Selected Interns (<span id="internCount">0</span>)</h3>
                    <button onclick="refreshInterns()" style="padding: 0.5rem 1rem; background: var(--accent-gradient); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div id="internsContainer">
                    <p class="no-data">Loading interns...</p>
                </div>
            </div>

            <!-- Weekly Tasks Tab -->
            <div id="weeklyTasksTab" class="intern-tab-content" style="display: none;">
                <h3 style="margin-bottom: 1.5rem;">Create Weekly Tasks</h3>
                
                <form id="taskCreationForm" style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 10px; margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #00d4ff;">Week Number</label>
                            <input type="number" id="weekNumber" min="1" required style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #00d4ff;">Due Date</label>
                            <input type="date" id="dueDate" style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; color: white;">
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #00d4ff;">Task Title</label>
                        <input type="text" id="taskTitle" required placeholder="e.g., Complete React Tutorial" style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; color: white;">
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #00d4ff;">Task Description</label>
                        <textarea id="taskDescription" required placeholder="Detailed description of the task..." style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; color: white; min-height: 100px; font-family: inherit;"></textarea>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #00ff88;">Mini Project Guidelines (Optional)</label>
                        <textarea id="miniProjectGuidelines" placeholder="Guidelines for mini project implementation..." style="width: 100%; padding: 0.75rem; background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 6px; color: white; min-height: 80px; font-family: inherit;"></textarea>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #0091ff;">DS & Algorithms Topic (Optional)</label>
                        <input type="text" id="dsAlgoTopic" placeholder="e.g., Binary Search Trees, Dynamic Programming" style="width: 100%; padding: 0.75rem; background: rgba(0, 145, 255, 0.05); border: 1px solid rgba(0, 145, 255, 0.3); border-radius: 6px; color: white;">
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ffd700;">AI Tool News (Optional)</label>
                        <textarea id="aiNews" placeholder="Latest AI tool updates and news..." style="width: 100%; padding: 0.75rem; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: white; min-height: 80px; font-family: inherit;"></textarea>
                    </div>

                    <button type="submit" style="padding: 0.75rem 2rem; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </form>

                <h3 style="margin-bottom: 1.5rem;">Existing Tasks</h3>
                <div id="existingTasksContainer">
                    <p class="no-data">No tasks created yet</p>
                </div>
            </div>

            <!-- Submissions Tab -->
            <div id="submissionsTab" class="intern-tab-content" style="display: none;">
                <h3 style="margin-bottom: 1.5rem;">Intern Submissions</h3>
                <div id="submissionsContainer">
                    <p class="no-data">Select an intern to view their submissions</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .intern-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #888;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .intern-tab:hover {
            color: #00d4ff;
        }

        .intern-tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        .intern-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .intern-info h4 {
            color: #00d4ff;
            margin-bottom: 0.5rem;
        }

        .intern-info p {
            color: #888;
            font-size: 0.9rem;
        }

        .intern-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-view {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #00d4ff 0%, #0091ff 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .select-intern-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            color: #0a0e27;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .select-intern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .select-intern-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <script>
        // API URL configuration
        const API_URL = window.location.origin;
        
        // Check admin authentication on page load
        function checkAuth() {
            const token = getCookie('admin_token') || localStorage.getItem('admin_token');
            if (!token) {
                // Not authenticated, redirect to login
                window.location.href = '/admin/login';
                return false;
            }
            return token;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function logout() {
            // Clear authentication
            document.cookie = 'admin_token=; path=/; max-age=0';
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_role');
            
            // Call logout API
            fetch(`${API_URL}/api/admin/logout`, {
                method: 'POST',
                headers: { 'Authorization': getCookie('admin_token') || localStorage.getItem('admin_token') }
            }).finally(() => {
                window.location.href = '/admin/login';
            });
        }

        // Add logout button and check auth on load
        window.addEventListener('load', () => {
            const token = checkAuth();
            if (!token) return;

            // Add logout button to nav
            const nav = document.querySelector('.nav-menu');
            if (nav && !document.getElementById('logoutBtn')) {
                const logoutLi = document.createElement('li');
                logoutLi.innerHTML = '<a href="#" id="logoutBtn" style="color: #ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</a>';
                nav.appendChild(logoutLi);
                
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirm('Are you sure you want to logout?')) {
                        logout();
                    }
                });
            }
        });

        // Check database status
        async function checkDatabase() {
            const token = checkAuth();
            if (!token) return;
            
            const statusEl = document.getElementById('dbStatus');
            statusEl.textContent = 'Checking...';
            
            try {
                const response = await fetch(`${API_URL}/api/admin/check-db`, {
                    headers: { 'Authorization': token }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                statusEl.innerHTML = `<strong>${data.database}</strong> - Users: ${data.stats.users}, Applications: ${data.stats.applications}, Emails: ${data.stats.emails}`;
                statusEl.style.color = 'var(--accent-color)';
                
                // Reload dashboard to show updated data
                loadDashboard();
                loadJobApplications();
            } catch (error) {
                console.error('Error checking database:', error);
                statusEl.textContent = 'Error checking database';
                statusEl.style.color = '#ef4444';
            }
        }
        
        async function loadDashboard() {
            const token = checkAuth();
            if (!token) return;
            
            try {
                // Fetch statistics with auth token
                const statsResponse = await fetch(`${API_URL}/api/stats`, {
                    headers: { 'Authorization': token }
                });
                
                if (statsResponse.status === 401) {
                    logout();
                    return;
                }
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('totalEmails').textContent = stats.total_emails || 0;
                    document.getElementById('todayUsers').textContent = stats.today_users || 0;
                }

                // Fetch users with auth token
                const usersResponse = await fetch(`${API_URL}/api/users`, {
                    headers: { 'Authorization': token }
                });
                
                if (usersResponse.status === 401) {
                    logout();
                    return;
                }
                
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    const users = usersData.users || [];
                    
                    const usersTableBody = document.getElementById('usersTableBody');
                    if (users.length === 0) {
                        usersTableBody.innerHTML = '<tr><td colspan="7" class="no-data">No users registered yet</td></tr>';
                    } else {
                        usersTableBody.innerHTML = users.map((user, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${user.phone}</td>
                                <td>${user.address}</td>
                                <td>${new Date(user.created_at).toLocaleString()}</td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                            </tr>
                        `).join('');
                    }
                }

                // Fetch emails with auth token
                const emailsResponse = await fetch(`${API_URL}/api/emails`, {
                    headers: { 'Authorization': token }
                });
                
                if (emailsResponse.status === 401) {
                    logout();
                    return;
                }
                
                if (emailsResponse.ok) {
                    const emailsData = await emailsResponse.json();
                    const emails = emailsData.emails || [];
                    
                    const emailsTableBody = document.getElementById('emailsTableBody');
                    if (emails.length === 0) {
                        emailsTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No emails sent yet</td></tr>';
                    } else {
                        emailsTableBody.innerHTML = emails.map((email, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${email.to_email}</td>
                                <td>${email.subject}</td>
                                <td>${new Date(email.sent_at).toLocaleString()}</td>
                                <td>${email.user_name || 'N/A'}</td>
                                <td><div class="email-content">${email.body.substring(0, 100)}...</div></td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load job applications
        async function loadJobApplications() {
            const token = checkAuth();
            if (!token) return;
            
            const applicationsSection = document.getElementById('jobApplicationsSection');
            try {
                const response = await fetch(`${API_URL}/api/admin/applications`, {
                    headers: { 'Authorization': token }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.applications) {
                    displayJobApplications(data.applications);
                } else {
                    applicationsSection.innerHTML = '<p class="no-data">No applications found</p>';
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                applicationsSection.innerHTML = `<p class="no-data">Error loading applications: ${error.message}<br>Make sure the backend server is running on ${API_URL}</p>`;
            }
        }

        function displayJobApplications(applications) {
            const applicationsSection = document.getElementById('jobApplicationsSection');
            
            if (applications.length === 0) {
                applicationsSection.innerHTML = '<p class="no-data">No job applications yet</p>';
                return;
            }

            // Group applications by position
            const grouped = {};
            applications.forEach(app => {
                if (!grouped[app.position]) {
                    grouped[app.position] = [];
                }
                grouped[app.position].push(app);
            });

            // Display grouped applications
            let html = '';
            for (const [position, apps] of Object.entries(grouped)) {
                html += `
                    <div class="users-table" style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">${position} (${apps.length} applicants)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>College</th>
                                    <th>Year</th>
                                    <th>Status</th>
                                    <th>Applied</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${apps.map((app, index) => `
                                    <tr id="app-row-${app.id}">
                                        <td>${index + 1}</td>
                                        <td>${app.fullName}</td>
                                        <td>${app.email}</td>
                                        <td>${app.phone}</td>
                                        <td>${app.college}</td>
                                        <td>${app.year}</td>
                                        <td>
                                            <select id="status-${app.id}" onchange="updateApplicationStatus(${app.id}, this.value)" style="padding: 0.4rem 0.6rem; border-radius: 6px; background: rgba(99, 102, 241, 0.2); color: #6366f1; border: 1px solid #6366f1; cursor: pointer;">
                                                <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="application_received" ${app.status === 'application_received' ? 'selected' : ''}>Application Received</option>
                                                <option value="under_review" ${app.status === 'under_review' ? 'selected' : ''}>Under Review</option>
                                                <option value="interview" ${app.status === 'interview' ? 'selected' : ''}>Interview</option>
                                                <option value="selected" ${app.status === 'selected' ? 'selected' : ''}>Selected</option>
                                                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                            </select>
                                        </td>
                                        <td>${new Date(app.appliedAt).toLocaleDateString()}</td>
                                        <td>
                                            <button onclick="sendStatusEmail(${app.id}, '${app.email}', '${app.fullName}', '${app.position}', document.getElementById('status-${app.id}').value)" style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                                Send Email
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            applicationsSection.innerHTML = html;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.removeItem('users');
                localStorage.removeItem('emails');
                localStorage.removeItem('currentUser');
                loadDashboard();
                alert('All data cleared successfully!');
            }
        }

        // Update application status
        async function updateApplicationStatus(appId, newStatus) {
            const token = checkAuth();
            if (!token) return;
            
            try {
                const response = await fetch(`${API_URL}/api/admin/applications/${appId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    console.log('Status updated successfully');
                    // Reload applications to reflect changes
                    loadJobApplications();
                } else {
                    alert('Error updating status: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Make sure backend is running.');
            }
        }

        // Send status email to candidate
        async function sendStatusEmail(appId, email, name, position, status) {
            const statusMessages = {
                'pending': {
                    subject: 'Application Received',
                    body: `Dear ${name},\n\nThank you for applying to the ${position} position at XGENAI.\n\nYour application is currently pending review. We will get back to you soon.\n\nBest regards,\nXGENAI Recruitment Team`
                },
                'application_received': {
                    subject: 'Application Received - ' + position,
                    body: `Dear ${name},\n\nWe have received your application for the ${position} position at XGENAI.\n\nOur team will review your application and contact you within 5-7 business days.\n\nBest regards,\nXGENAI Recruitment Team`
                },
                'under_review': {
                    subject: 'Application Under Review - ' + position,
                    body: `Dear ${name},\n\nYour application for the ${position} position is currently under review by our recruitment team.\n\nWe appreciate your patience and will update you on the next steps soon.\n\nBest regards,\nXGENAI Recruitment Team`
                },
                'interview': {
                    subject: 'Interview Invitation - ' + position,
                    body: `Dear ${name},\n\nCongratulations! We are impressed with your application for the ${position} position.\n\nWe would like to invite you for an interview. Our team will contact you shortly to schedule a convenient time.\n\nPlease prepare to discuss your experience and interest in this role.\n\nBest regards,\nXGENAI Recruitment Team`
                },
                'selected': {
                    subject: 'Congratulations! You have been selected - ' + position,
                    body: `Dear ${name},\n\nWe are delighted to inform you that you have been selected for the ${position} position at XGENAI!\n\nCongratulations on your successful application. Our team will contact you shortly with the next steps and onboarding details.\n\nWe look forward to having you on our team!\n\nBest regards,\nXGENAI Recruitment Team`
                },
                'rejected': {
                    subject: 'Application Status Update - ' + position,
                    body: `Dear ${name},\n\nThank you for your interest in the ${position} position at XGENAI and for taking the time to apply.\n\nAfter careful consideration, we regret to inform you that we will not be moving forward with your application at this time.\n\nWe appreciate your interest in XGENAI and encourage you to apply for future opportunities that match your skills and experience.\n\nBest regards,\nXGENAI Recruitment Team`
                }
            };

            const emailData = statusMessages[status];
            
            if (!emailData) {
                alert('Invalid status selected');
                return;
            }

            if (!confirm(`Send ${status.replace('_', ' ')} email to ${name}?`)) {
                return;
            }

            try {
                const token = checkAuth();
                if (!token) return;
                
                const response = await fetch(`${API_URL}/api/admin/send-application-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        applicationId: appId,
                        email: email,
                        subject: emailData.subject,
                        body: emailData.body
                    })
                });

                const result = await response.json();
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    alert('Email sent successfully!');
                } else {
                    alert('Error sending email: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert('Failed to send email. Make sure backend is running.');
            }
        }

        // Load dashboard on page load
        loadDashboard();
        loadJobApplications();
        loadInterns();

        // Refresh every 5 seconds
        setInterval(() => {
            loadDashboard();
            loadJobApplications();
        }, 5000);

        // ============================================================
        // INTERN MANAGEMENT FUNCTIONS
        // ============================================================

        // Tab switching
        function showInternTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.intern-tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.intern-tab').forEach(t => t.classList.remove('active'));

            // Show selected tab
            if (tab === 'selected') {
                document.getElementById('selectedInternsTab').style.display = 'block';
                document.getElementById('selectedTab').classList.add('active');
                loadInterns();
            } else if (tab === 'tasks') {
                document.getElementById('weeklyTasksTab').style.display = 'block';
                document.getElementById('tasksTab').classList.add('active');
                loadExistingTasks();
            } else if (tab === 'submissions') {
                document.getElementById('submissionsTab').style.display = 'block';
                document.getElementById('submissionsTab').classList.add('active');
                loadAllSubmissions();
            }
        }

        // Load selected interns
        async function loadInterns() {
            const token = getCookie('admin_token') || localStorage.getItem('admin_token');
            const container = document.getElementById('internsContainer');

            try {
                const response = await fetch(`${API_URL}/api/admin/interns`, {
                    headers: { 'Authorization': token }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                if (data.interns && data.interns.length > 0) {
                    document.getElementById('internCount').textContent = data.interns.length;
                    container.innerHTML = data.interns.map(intern => `
                        <div class="intern-card">
                            <div class="intern-info">
                                <h4>${intern.name}</h4>
                                <p>
                                    <i class="fas fa-envelope"></i> ${intern.email} | 
                                    <i class="fas fa-briefcase"></i> ${intern.position} | 
                                    <i class="fas fa-university"></i> ${intern.college}
                                </p>
                                <p style="font-size: 0.85rem;">
                                    Started: ${new Date(intern.start_date).toLocaleDateString()} | 
                                    Status: <span style="color: ${intern.status === 'active' ? '#00ff88' : '#ff4444'}">${intern.status}</span>
                                </p>
                            </div>
                            <div class="intern-actions">
                                <button class="btn-view" onclick="viewInternDashboard(${intern.id})">
                                    <i class="fas fa-chart-line"></i> View Dashboard
                                </button>
                                <button class="btn-view" onclick="viewInternSubmissions(${intern.id}, '${intern.name}')">
                                    <i class="fas fa-tasks"></i> Submissions
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('internCount').textContent = '0';
                    container.innerHTML = '<p class="no-data">No interns selected yet. Select applicants from the Applications section above.</p>';
                }
            } catch (error) {
                console.error('Error loading interns:', error);
                container.innerHTML = '<p class="no-data">Error loading interns</p>';
            }
        }

        function refreshInterns() {
            loadInterns();
        }

        // View intern submissions
        async function viewInternSubmissions(internId, internName) {
            const token = getCookie('admin_token') || localStorage.getItem('admin_token');

            try {
                const response = await fetch(`${API_URL}/api/admin/intern-submissions/${internId}`, {
                    headers: { 'Authorization': token }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                // Switch to submissions tab and display
                showInternTab('submissions');
                const container = document.getElementById('submissionsContainer');

                if (data.submissions && data.submissions.length > 0) {
                    container.innerHTML = `
                        <h4 style="margin-bottom: 1.5rem; color: #00d4ff;">Submissions by ${internName}</h4>
                        ${data.submissions.map(sub => `
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #00d4ff;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="color: #00d4ff; margin-bottom: 0.5rem;">${sub.task_title}</h4>
                                        <p style="color: #888; font-size: 0.9rem;">
                                            Week ${sub.week_number} • Submitted: ${new Date(sub.submitted_at).toLocaleString()}
                                        </p>
                                        <p style="color: #888; font-size: 0.9rem;">File Type: ${sub.submission_type}</p>
                                    </div>
                                    <span style="padding: 0.5rem 1rem; background: rgba(0, 255, 136, 0.2); color: #00ff88; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                        ${sub.status}
                                    </span>
                                </div>
                                ${sub.what_learned ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(0, 255, 136, 0.05); border-radius: 8px;">
                                        <h5 style="color: #00ff88; margin-bottom: 0.5rem;"><i class="fas fa-lightbulb"></i> What They Learned:</h5>
                                        <p style="color: #ccc; line-height: 1.6;">${sub.what_learned}</p>
                                    </div>
                                ` : ''}
                                ${sub.submission_file ? `
                                    <button onclick="viewSubmissionFile('${sub.submission_file}', '${sub.submission_type}')" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #0091ff; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        <i class="fas fa-eye"></i> View File
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    `;
                } else {
                    container.innerHTML = `<p class="no-data">${internName} hasn't submitted any tasks yet</p>`;
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        function viewSubmissionFile(fileData, fileType) {
            // Open file in new window
            const newWindow = window.open();
            if (fileType === 'pdf') {
                newWindow.document.write(`<iframe src="${fileData}" width="100%" height="100%" style="border: none;"></iframe>`);
            } else {
                newWindow.document.write(`<img src="${fileData}" style="max-width: 100%; height: auto;">`);
            }
        }

        function viewInternDashboard(internId) {
            alert('Dashboard analytics feature coming soon!');
            // Future: Show detailed analytics, progress charts, etc.
        }

        // Create weekly task
        document.getElementById('taskCreationForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = getCookie('admin_token') || localStorage.getItem('admin_token');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            const taskData = {
                week_number: parseInt(document.getElementById('weekNumber').value),
                task_title: document.getElementById('taskTitle').value,
                task_description: document.getElementById('taskDescription').value,
                mini_project_guidelines: document.getElementById('miniProjectGuidelines').value,
                ds_algo_topic: document.getElementById('dsAlgoTopic').value,
                ai_news: document.getElementById('aiNews').value,
                due_date: document.getElementById('dueDate').value
            };

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                const response = await fetch(`${API_URL}/api/admin/weekly-task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    alert('✅ Task created successfully!');
                    e.target.reset();
                    loadExistingTasks();
                } else {
                    alert('Error: ' + (data.error || 'Failed to create task'));
                }
            } catch (error) {
                console.error('Error creating task:', error);
                alert('Failed to create task. Check console for details.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Create Task';
            }
        });

        // Load existing tasks (placeholder)
        function loadExistingTasks() {
            document.getElementById('existingTasksContainer').innerHTML = '<p class="no-data">Task list view coming soon</p>';
        }

        // Load all submissions (placeholder)
        function loadAllSubmissions() {
            document.getElementById('submissionsContainer').innerHTML = '<p class="no-data">Select an intern to view their submissions</p>';
        }

        // Add select intern button to applications
        function displayJobApplications(applications) {
            const applicationsSection = document.getElementById('jobApplicationsSection');
            
            if (applications.length === 0) {
                applicationsSection.innerHTML = '<p class="no-data">No job applications yet</p>';
                return;
            }

            // Group applications by position
            const grouped = {};
            applications.forEach(app => {
                if (!grouped[app.position]) {
                    grouped[app.position] = [];
                }
                grouped[app.position].push(app);
            });

            // Display grouped applications
            let html = '';
            for (const [position, apps] of Object.entries(grouped)) {
                html += `
                    <div class="users-table" style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">${position} (${apps.length} applicants)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>College</th>
                                    <th>Applied Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${apps.map(app => `
                                    <tr>
                                        <td>${app.id}</td>
                                        <td>${app.full_name}</td>
                                        <td>${app.email}</td>
                                        <td>${app.college}</td>
                                        <td>${new Date(app.applied_at).toLocaleDateString()}</td>
                                        <td>
                                            <span style="padding: 0.25rem 0.75rem; background: ${
                                                app.status === 'selected' ? 'rgba(0, 255, 136, 0.2)' : 
                                                app.status === 'rejected' ? 'rgba(255, 68, 68, 0.2)' : 
                                                'rgba(255, 215, 0, 0.2)'
                                            }; color: ${
                                                app.status === 'selected' ? '#00ff88' : 
                                                app.status === 'rejected' ? '#ff4444' : 
                                                '#ffd700'
                                            }; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                                ${app.status}
                                            </span>
                                        </td>
                                        <td>
                                            ${app.status !== 'selected' ? `
                                                <button class="select-intern-btn" onclick="selectAsIntern(${app.id}, '${app.full_name}', '${app.email}')">
                                                    <i class="fas fa-user-check"></i> Select as Intern
                                                </button>
                                            ` : `
                                                <span style="color: #00ff88;"><i class="fas fa-check-circle"></i> Selected</span>
                                            `}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            applicationsSection.innerHTML = html;
        }

        // Select applicant as intern
        async function selectAsIntern(applicationId, name, email) {
            if (!confirm(`Select ${name} as an intern?\n\nThey will receive login credentials via email.`)) {
                return;
            }

            const token = getCookie('admin_token') || localStorage.getItem('admin_token');

            try {
                const response = await fetch(`${API_URL}/api/admin/select-intern`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        application_id: applicationId,
                        default_password: 'Intern@123' // Default password
                    })
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ ${name} has been selected as an intern!\n\nLogin credentials sent to: ${email}\nDefault password: Intern@123`);
                    loadJobApplications();
                    loadInterns();
                } else {
                    alert('Error: ' + (data.error || 'Failed to select intern'));
                }
            } catch (error) {
                console.error('Error selecting intern:', error);
                alert('Failed to select intern. Check console for details.');
            }
        }

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            const token = checkAuth();
            if (!token) return;

            // Load all dashboard data
            loadDashboard();
            loadJobApplications();
            loadInterns();

            console.log('✅ Admin dashboard initialized and data loaded');
        });
    </script>
</body>
</html>
