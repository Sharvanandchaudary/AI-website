<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“‹ Recruiter Dashboard - ZGENAI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 30px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .navbar h1 { font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 2px solid white; padding: 10px 25px; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background: white; color: #667eea; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; }
        .stat-icon.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-icon.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.purple { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-info h3 { font-size: 32px; color: #333; margin-bottom: 5px; }
        .stat-info p { color: #666; font-size: 14px; }
        .section-card { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .section-header h2 { font-size: 22px; color: #333; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 15px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .application-list { max-height: 600px; overflow-y: auto; }
        .app-item { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea; transition: all 0.3s; }
        .app-item:hover { background: #e9ecef; transform: translateX(5px); }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 18px; font-weight: 600; color: #333; }
        .app-status { padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-applied { background: #cce5ff; color: #004085; }
        .status-interviewing { background: #fff3cd; color: #856404; }
        .status-offer { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .app-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px; color: #666; margin-bottom: 12px; }
        .app-actions { display: flex; gap: 10px; }
        .app-actions button { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s; color: white; }
        .btn-edit { background: #667eea; }
        .btn-delete { background: #f5576c; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h3 { font-size: 24px; color: #333; }
        .close-modal { font-size: 28px; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state i { font-size: 64px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1><i class="fas fa-user-tie"></i> ZGENAI Recruiter Portal</h1>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">R</div>
            <div>
                <div style="font-weight: 600;" id="userName">Loading...</div>
                <div style="font-size: 13px; opacity: 0.9;" id="userEmail"></div>
            </div>
            <button class="logout-btn" onclick="openPasswordModal()" style="margin-right: 10px; background: rgba(255,255,255,0.15);"><i class="fas fa-key"></i> Change Password</button>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fas fa-briefcase"></i></div>
                <div class="stat-info"><h3 id="totalApplications">0</h3><p>Total Applications</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fas fa-handshake"></i></div>
                <div class="stat-info"><h3 id="offersReceived">0</h3><p>Offers Received</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange"><i class="fas fa-comments"></i></div>
                <div class="stat-info"><h3 id="interviewing">0</h3><p>Interviewing</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-info"><h3 id="thisWeek">0</h3><p>This Week</p></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-list"></i> My Job Applications</h2>
                <button class="btn-primary" onclick="openApplicationModal()">
                    <i class="fas fa-plus"></i> Add Application
                </button>
            </div>
            <div class="application-list" id="applicationList">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No applications yet. Start tracking your job applications!</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="applicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-briefcase"></i> Add Job Application</h3>
                <span class="close-modal" onclick="closeApplicationModal()">&times;</span>
            </div>
            <form id="applicationForm">
                <input type="hidden" id="applicationId">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="companyName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Position *</label>
                        <input type="text" id="position" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Application Date *</label>
                        <input type="date" id="applicationDate" required>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="status" required>
                            <option value="applied">Applied</option>
                            <option value="interviewing">Interviewing</option>
                            <option value="offer">Offer Received</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Salary Range</label>
                        <input type="text" id="salaryRange" placeholder="e.g., $50k-$70k">
                    </div>
                    <div class="form-group">
                        <label>Job Type</label>
                        <select id="jobType">
                            <option value="full-time">Full-Time</option>
                            <option value="part-time">Part-Time</option>
                            <option value="contract">Contract</option>
                            <option value="internship">Internship</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Job URL</label>
                    <input type="url" id="jobUrl" placeholder="https://">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" placeholder="Add any notes about this application..."></textarea>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> Save Application
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let userToken = localStorage.getItem('userToken');
        let userName = localStorage.getItem('userName');
        let userEmail = localStorage.getItem('userEmail');
        let editingId = null;

        if (!userToken || localStorage.getItem('userRole') !== 'recruiter') {
            window.location.href = '/user-login';
        }

        document.getElementById('userName').textContent = userName;
        document.getElementById('userEmail').textContent = userEmail;
        document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

        window.addEventListener('DOMContentLoaded', () => {
            loadApplications();
            loadStats();
            document.getElementById('applicationDate').valueAsDate = new Date();
        });

        async function loadApplications() {
            try {
                const response = await fetch(`${API_URL}/api/recruiter/applications`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    displayApplications(data.applications || []);
                }
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        function displayApplications(applications) {
            const list = document.getElementById('applicationList');
            if (applications.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No applications yet</p></div>';
                return;
            }
            list.innerHTML = applications.map(app => `
                <div class="app-item">
                    <div class="app-header">
                        <div class="app-title">${app.company_name} - ${app.position}</div>
                        <span class="app-status status-${app.status}">${app.status.toUpperCase()}</span>
                    </div>
                    <div class="app-details">
                        <div><i class="fas fa-map-marker-alt"></i> ${app.location || 'Remote'}</div>
                        <div><i class="fas fa-calendar"></i> Applied: ${new Date(app.application_date).toLocaleDateString()}</div>
                        <div><i class="fas fa-dollar-sign"></i> ${app.salary_range || 'Not specified'}</div>
                        <div><i class="fas fa-clock"></i> ${app.job_type || 'Full-time'}</div>
                    </div>
                    ${app.notes ? `<div style="color:#666;font-size:13px;margin-bottom:10px;"><i class="fas fa-sticky-note"></i> ${app.notes}</div>` : ''}
                    ${app.job_url ? `<div style="margin-bottom:10px;"><a href="${app.job_url}" target="_blank" style="color:#667eea;font-size:13px;"><i class="fas fa-external-link-alt"></i> View Job Posting</a></div>` : ''}
                    <div class="app-actions">
                        <button class="btn-edit" onclick="editApplication(${app.id})"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn-delete" onclick="deleteApplication(${app.id})"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/recruiter/stats`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalApplications').textContent = data.total || 0;
                    document.getElementById('offersReceived').textContent = data.offers || 0;
                    document.getElementById('interviewing').textContent = data.interviewing || 0;
                    document.getElementById('thisWeek').textContent = data.this_week || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function openApplicationModal() {
            editingId = null;
            document.getElementById('applicationForm').reset();
            document.getElementById('applicationDate').valueAsDate = new Date();
            document.getElementById('applicationModal').classList.add('active');
        }

        function closeApplicationModal() {
            document.getElementById('applicationModal').classList.remove('active');
        }

        document.getElementById('applicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                company_name: document.getElementById('companyName').value,
                position: document.getElementById('position').value,
                location: document.getElementById('location').value,
                application_date: document.getElementById('applicationDate').value,
                status: document.getElementById('status').value,
                salary_range: document.getElementById('salaryRange').value,
                job_type: document.getElementById('jobType').value,
                job_url: document.getElementById('jobUrl').value,
                notes: document.getElementById('notes').value
            };

            try {
                const url = editingId ? `${API_URL}/api/recruiter/applications/${editingId}` : `${API_URL}/api/recruiter/applications`;
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeApplicationModal();
                    loadApplications();
                    loadStats();
                    alert(editingId ? 'Application updated!' : 'Application added!');
                }
            } catch (error) {
                alert('Failed to save application');
            }
        });

        async function editApplication(id) {
            try {
                const response = await fetch(`${API_URL}/api/recruiter/applications/${id}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                if (response.ok) {
                    const app = await response.json();
                    editingId = id;
                    document.getElementById('companyName').value = app.company_name;
                    document.getElementById('position').value = app.position;
                    document.getElementById('location').value = app.location || '';
                    document.getElementById('applicationDate').value = app.application_date.split('T')[0];
                    document.getElementById('status').value = app.status;
                    document.getElementById('salaryRange').value = app.salary_range || '';
                    document.getElementById('jobType').value = app.job_type || 'full-time';
                    document.getElementById('jobUrl').value = app.job_url || '';
                    document.getElementById('notes').value = app.notes || '';
                    document.getElementById('applicationModal').classList.add('active');
                }
            } catch (error) {
                alert('Failed to load application');
            }
        }

        async function deleteApplication(id) {
            if (!confirm('Are you sure you want to delete this application?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/recruiter/applications/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                if (response.ok) {
                    loadApplications();
                    loadStats();
                    alert('Application deleted!');
                }
            } catch (error) {
                alert('Failed to delete application');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/user-login';
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').classList.add('active');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        async function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/recruiter/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… Password changed successfully! Please login again with your new password.');
                    logout();
                } else {
                    alert(data.error || 'Failed to change password');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Connection error. Please try again.');
            }
        }
    </script>

    <!-- Password Change Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Change Password</h3>
                <span class="close-modal" onclick="closePasswordModal()">&times;</span>
            </div>
            <form onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" required placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" required minlength="6" placeholder="Enter new password (min 6 characters)">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" required minlength="6" placeholder="Confirm new password">
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-check"></i> Update Password</button>
            </form>
        </div>
    </div>

</body>
</html>
